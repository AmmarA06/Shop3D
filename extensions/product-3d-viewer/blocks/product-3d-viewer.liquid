{% comment %}
  3D Product Viewer Block
  Interactive widget for browsing products in 3D
{% endcomment %}

{{ 'product-3d-viewer.css' | asset_url | stylesheet_tag }}

<div
  class="product-3d-viewer"
  data-shop-domain="{{ shop.permanent_domain }}"
  data-api-url="{{ shop.url }}"
  {{ block.shopify_attributes }}
>
  <!-- Widget Button (Initial State) -->
  <div class="product-3d-viewer__widget" data-widget>
    <div class="product-3d-viewer__widget-card">
      <div class="product-3d-viewer__widget-icon">
        <svg width="64" height="64" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="64" height="64" rx="12" fill="url(#gradient1)"/>
          <path d="M32 16L18 24V40L32 48L46 40V24L32 16Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
          <path d="M32 32V48" stroke="white" stroke-width="2" stroke-linecap="round"/>
          <path d="M18 24L32 32L46 24" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="gradient1" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
              <stop stop-color="#00D68F"/>
              <stop offset="1" stop-color="#00866B"/>
            </linearGradient>
          </defs>
        </svg>
      </div>
      <div class="product-3d-viewer__widget-content">
        <h3 class="product-3d-viewer__widget-title">View Products in 3D</h3>
        <p class="product-3d-viewer__widget-description">Explore our products with interactive 3D models. Rotate, zoom, and examine every detail.</p>
      </div>
      <button type="button" class="product-3d-viewer__widget-button" data-open-viewer>
        <span>Open 3D Viewer</span>
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Full Viewer (Hidden Initially) -->
  <div class="product-3d-viewer__viewer" data-viewer style="display: none;">
    <div class="product-3d-viewer__viewer-header">
      <div class="product-3d-viewer__viewer-title">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 6L4 10V18L12 22L20 18V10L12 6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 12V22" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M4 10L12 12L20 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <h3>3D Product Viewer</h3>
      </div>
      <button type="button" class="product-3d-viewer__viewer-close" data-close-viewer aria-label="Close viewer">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
    
    <div class="product-3d-viewer__layout">
    <!-- Main Viewer -->
    <div class="product-3d-viewer__main">
      <div class="product-3d-viewer__container">
    {%- if block.settings.show_header -%}
      <div class="product-3d-viewer__header">
        <h3 class="product-3d-viewer__title">
          {{ block.settings.heading | default: "View in 3D" }}
        </h3>
      </div>
    {%- endif -%}

    <!-- Loading state -->
    <div class="product-3d-viewer__loading" data-loading>
      <div class="product-3d-viewer__spinner"></div>
      <p>{{ block.settings.loading_text | default: "Loading 3D model..." }}</p>
    </div>

    <!-- Error state -->
    <div class="product-3d-viewer__error" data-error style="display: none;">
      <p>{{ block.settings.error_text | default: "3D model not available for this product" }}</p>
    </div>

    <!-- 3D viewer canvas container -->
    <div class="product-3d-viewer__canvas" data-canvas style="display: none;">
      <!-- Three.js will render here -->
    </div>

    {%- if block.settings.show_instructions -%}
      <div class="product-3d-viewer__instructions">
        <p>{{ block.settings.instructions_text | default: "Click and drag to rotate • Scroll to zoom • Right-click to pan" }}</p>
      </div>
    {%- endif -%}
      </div>
    </div>

    <!-- Sidebar -->
    <div class="product-3d-viewer__sidebar">
      <!-- Product Selector -->
      <div class="product-3d-viewer__card">
        <div class="product-3d-viewer__card-header">
          <h4 class="product-3d-viewer__card-title">Select Product</h4>
        </div>
        <div class="product-3d-viewer__card-body">
          <div class="product-3d-viewer__product-list" data-product-list>
            <!-- Products will be loaded dynamically via JavaScript -->
            <div style="text-align: center; padding: 1rem; color: #666;">
              Loading products...
            </div>
          </div>
        </div>
      </div>

      <!-- Controls -->
      <div class="product-3d-viewer__card">
        <div class="product-3d-viewer__card-header">
          <h4 class="product-3d-viewer__card-title">Controls</h4>
        </div>
        <div class="product-3d-viewer__card-body">
          <div class="product-3d-viewer__control-list">
            <button
              type="button"
              class="product-3d-viewer__control-list-btn"
              data-control="auto-rotate"
              aria-label="Toggle auto-rotate"
            >
              <span data-rotate-text>Start Auto-Rotate</span>
            </button>
            <button
              type="button"
              class="product-3d-viewer__control-list-btn"
              data-control="grid"
              aria-label="Toggle grid"
            >
              <span data-grid-text>Hide Grid</span>
            </button>
            <button
              type="button"
              class="product-3d-viewer__control-list-btn"
              data-control="reset"
              aria-label="Reset camera"
            >
              Reset Camera
            </button>
          </div>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/"
    }
  }
</script>
<script type="module" src="{{ 'product-3d-viewer.js' | asset_url }}"></script>

{% schema %}
{
  "name": "3D Product Viewer",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_header",
      "label": "Show header",
      "default": true
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "View in 3D"
    },
    {
      "type": "checkbox",
      "id": "show_instructions",
      "label": "Show instructions",
      "default": true
    },
    {
      "type": "text",
      "id": "instructions_text",
      "label": "Instructions text",
      "default": "Click and drag to rotate • Scroll to zoom • Right-click to pan"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "Loading text",
      "default": "Loading 3D model..."
    },
    {
      "type": "text",
      "id": "error_text",
      "label": "Error text",
      "default": "3D model not available for this product"
    },
    {
      "type": "range",
      "id": "viewer_height",
      "min": 300,
      "max": 800,
      "step": 50,
      "unit": "px",
      "label": "Viewer height",
      "default": 700
    },
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Auto-rotate by default",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_grid",
      "label": "Show grid",
      "default": true
    }
  ]
}
{% endschema %}
